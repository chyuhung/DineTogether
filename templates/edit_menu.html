<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" value="width=device-width, initial-scale=1.0">
        <title>DineTogether - 编辑菜谱</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-out;
            }
            .btn-hover:hover {
                transform: scale(1.05);
                transition: transform 0.2s ease-in-out;
            }
        </style>
        <script>
            window.onload = function() {
                const userId = localStorage.getItem('user_id');
                const role = localStorage.getItem('role');
                if (!userId) {
                    alert('请先登录！');
                    location.href = '/login';
                } else if (role !== 'admin') {
                    alert('需要管理员权限！');
                    location.href = '/';
                } else {
                    loadMenu();
                }
            }

            async function loadMenu() {
                const menuId = location.pathname.split('/').pop();
                try {
                    const response = await fetch(`/menu/${menuId}`, { credentials: 'include' });
                    const menu = await response.json();
                    if (menu.error) {
                        alert(menu.error);
                        location.href = '/menu-manage';
                        return;
                    }
                    document.getElementById('edit_id').value = menu.id;
                    document.getElementById('edit_name').value = menu.name;
                    document.getElementById('edit_description').value = menu.description || '';
                    document.getElementById('edit_energy_cost').value = menu.energy_cost;
                } catch (error) {
                    alert('加载菜谱详情失败，请稍后重试！');
                    location.href = '/menu-manage';
                }
            }

            async function updateMenu() {
                const id = document.getElementById('edit_id').value;
                const name = document.getElementById('edit_name').value;
                const description = document.getElementById('edit_description').value;
                const energyCost = parseInt(document.getElementById('edit_energy_cost').value);
                if (!name || !energyCost || energyCost <= 0) {
                    alert('请填写所有字段，且能量值需为正整数！');
                    return;
                }
                try {
                    const response = await fetch(`/menu/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description, energy_cost: energyCost }),
                        credentials: 'include'
                    });
                    const result = await response.json();
                    if (result.message === '菜谱更新成功') {
                        alert('菜谱更新成功！');
                        location.href = '/menu-manage';
                    } else {
                        alert(result.error || '更新失败，请重试！');
                    }
                } catch (error) {
                    alert('网络错误，请稍后重试！');
                }
            }
        </script>
    </head>
    <body class="bg-gradient-to-br from-blue-600 to-purple-800 min-h-screen flex items-center justify-center font-sans">
        <div class="container mx-auto p-4 max-w-md">
            <div class="bg-white rounded-2xl shadow-xl p-6 fade-in">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">编辑 DineTogether 菜谱</h1>
                <form id="form" class="flex flex-col space-y-4">
                    <input id="edit_id" type="hidden">
                    <input id="edit_name" type="text" placeholder="菜品名称" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600">
                    <textarea id="edit_description" placeholder="描述" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 h-24"></textarea>
                    <input id="edit_energy_cost" type="number" placeholder="所需能量值" min="1" class="p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600">
                    <button type="button" onclick="updateMenu()" class="bg-green-600 text-white p-3 rounded-lg font-semibold btn-hover">
                        保存更改
                    </button>
                </form>
            </div>
        </div>
    </body>
</html>